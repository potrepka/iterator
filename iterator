#!/bin/bash
set -e

VERSION='0.1.0'
REPO='potrepka/iterator'
BINARY='iterator'

auto_update() {
    local self
    self=$(realpath "$0")
    local remote_version
    remote_version=$(curl -fsSL "https://api.github.com/repos/$REPO/releases/latest" 2>/dev/null \
        | grep '"tag_name"' | sed 's/.*"tag_name": *"v\?\([^"]*\)".*/\1/' || true)
    if [ -n "$remote_version" ] && [ "$remote_version" != "$VERSION" ]; then
        echo "Updating $BINARY ($VERSION -> $remote_version)..."
        local tmp
        tmp=$(mktemp)
        if curl -fsSL "https://raw.githubusercontent.com/$REPO/v$remote_version/$BINARY" -o "$tmp" 2>/dev/null; then
            mv "$tmp" "$self"
            chmod +x "$self"
            echo "Updated. Re-running..."
            exec "$self" "$@"
        else
            rm -f "$tmp"
        fi
    fi
}

auto_update "$@"

require_val() {
    local flag="$1" val="$2"
    if [ -z "$val" ] || [[ "$val" == --* ]]; then
        echo "Missing value for $flag"
        exit 1
    fi
}

require_int() {
    local flag="$1" val="$2"
    require_val "$flag" "$val"
    if ! [[ "$val" =~ ^[0-9]+$ ]]; then
        echo "$flag requires a non-negative integer, got: $val"
        exit 1
    fi
}

PR=''
TERMINAL='opencode run'
PROMPT=''
OUTPUT=''
SEARCH=8
LOOP=128
REPEAT=4

while [[ $# -gt 0 ]]; do
    case $1 in
        --terminal) require_val "$1" "$2"; TERMINAL="$2"; shift 2 ;;
        --prompt)   require_val "$1" "$2"; PROMPT="$2";   shift 2 ;;
        --output)   require_val "$1" "$2"; OUTPUT="$2";   shift 2 ;;
        --search)   require_int "$1" "$2"; SEARCH="$2";   shift 2 ;;
        --loop)     require_int "$1" "$2"; LOOP="$2";     shift 2 ;;
        --repeat)   require_int "$1" "$2"; REPEAT="$2";   shift 2 ;;
        *)
            if [ -z "$PR" ]; then
                PR="$1"; shift
            else
                echo "Unknown argument: $1"; exit 1
            fi
            ;;
    esac
done

if [ -z "$PR" ]; then
    echo "Usage: iterator PR [OPTIONS]"
    exit 1
fi

BRANCH=$(git branch --show-current 2>/dev/null || true)
if [ -z "$BRANCH" ]; then
    echo "Not in a git repository or no branch checked out"
    exit 1
fi
[ -z "$PROMPT" ] && PROMPT='/review $PR'
[ -z "$OUTPUT" ] && OUTPUT='bugs/$BRANCH.md'
PROMPT="${PROMPT//\$PR/$PR}"
PROMPT="${PROMPT//\$BRANCH/$BRANCH}"
OUTPUT="${OUTPUT//\$PR/$PR}"
OUTPUT="${OUTPUT//\$BRANCH/$BRANCH}"
mkdir -p "$(dirname "$OUTPUT")"

echo "PR=$PR BRANCH=$BRANCH TERMINAL=$TERMINAL"
echo "PROMPT=$PROMPT OUTPUT=$OUTPUT SEARCH=$SEARCH LOOP=$LOOP REPEAT=$REPEAT"

for ((r=1; r<=REPEAT; r++)); do
    echo "=== Round $r/$REPEAT ==="

    echo "--- Search ---"
    for ((s=1; s<=SEARCH; s++)); do
        echo "  Search $s/$SEARCH"
        $TERMINAL "$PROMPT
Please compare these bugs with $OUTPUT to find duplicates, and add the non-duplicates to $OUTPUT." || { rc=$?; echo "  Search $s failed (exit $rc), continuing..."; }
    done

    echo "--- Fix ---"
    fix=1
    while [ -f "$OUTPUT" ] && [ "$fix" -le "$LOOP" ]; do
        echo "  Fix $fix"
        $TERMINAL "Please identify the easiest bug in $OUTPUT to fix, and fix it. Then remove it from $OUTPUT, and if $OUTPUT is empty, delete the file. Then commit and push." || { rc=$?; echo "  Fix $fix failed (exit $rc), continuing..."; }
        fix=$((fix + 1))
    done
done

echo "Done."
